<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#7A8471" />
  <title>Pre-class: Hebron–Paris Connection (B1)</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Questrial&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- TensorFlow.js for semantic similarity scoring -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>

  <style>
    /* ——— Theme tokens ——— */
    :root {
      --primary-sage: #7A8471;
      --secondary-sage: #9CAF88;
      --tertiary-sage: #B8C5A6;
      --warm-cream: #F8F6F0;
      --soft-white: #FEFCF7;
      --forest-shadow: #5A6B52;
      --border-sage: rgba(122, 132, 113, 0.20);
      --hover-sage: rgba(156, 175, 136, 0.12);
      --focus-ring: color-mix(in oklab, var(--secondary-sage) 60%, white);
      --correct-bg: #E8F5E9;
      --correct-border: #2E7D32;
      --incorrect-bg: #FFEBEE;
      --incorrect-border: #C62828;
      --radius-md: 12px;
      --radius-xl: 20px;
      --radius-2xl: 28px;
      --space-3: 12px;
      --space-4: 16px;
      --space-8: 32px;
      --space-12: 48px;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; width: 100%; min-height: 100vh;
      font-family: 'Nunito', sans-serif; line-height: 1.6;
      color: var(--forest-shadow); background: var(--warm-cream);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    #app-wrapper {
      display: flex; justify-content: center; align-items: flex-start;
      padding: var(--space-8); padding-bottom: calc(var(--space-8) + env(safe-area-inset-bottom));
      width: 100%; min-height: 100vh;
    }

    .activity-container {
      width: 100%; max-width: 960px; background: var(--soft-white);
      border-radius: var(--radius-2xl); border: 1px solid var(--border-sage);
      padding: var(--space-12); box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    }

    header { text-align: center; margin-bottom: var(--space-4); }
    h1 { font-family: 'Questrial', sans-serif; font-size: clamp(1.8rem, 1.5rem + 1.4vw, 2.4rem); margin: 0; }
    h2 { font-size: clamp(1.2rem, 1rem + 0.5vw, 1.5rem); margin: 0 0 4px 0; }
    p { margin: 0 0 10px 0; }

    .rubric { color: var(--secondary-sage); font-weight: 700; margin-bottom: 4px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: var(--warm-cream); border: 1px solid var(--border-sage); font-weight: 700; color: var(--forest-shadow); }
    .instruction-list { margin: 12px 0 0 0; padding-left: 20px; }

    /* Navigation */
    .screen-nav { display: flex; align-items: center; gap: 12px; margin: 0 0 var(--space-4) 0; }
    .progress { flex: 1; }
    .progress-track { position: relative; width: 100%; height: 10px; background: var(--warm-cream); border: 1px solid var(--border-sage); border-radius: 999px; overflow: hidden; }
    .progress-fill { position: absolute; left: 0; top: 0; height: 100%; width: 25%; background: var(--primary-sage); transition: width 280ms ease; }
    .nav-btn { border: none; background: var(--primary-sage); color: #fff; border-radius: var(--radius-md); padding: 10px 16px; font-weight: 700; cursor: pointer; transition: transform 120ms ease, background 160ms ease; }
    .nav-btn:disabled { background: var(--tertiary-sage); cursor: not-allowed; }
    .nav-btn:hover:not(:disabled) { transform: translateY(-1px); background: var(--forest-shadow); }

    /* Cards */
    .card { border: 1px solid var(--border-sage); border-radius: var(--radius-xl); padding: var(--space-4); background: var(--soft-white); }
    .muted { color: #6f7b66; }
    .context { background: var(--warm-cream); border-radius: var(--radius-xl); padding: var(--space-4); border: 1px solid var(--border-sage); }
    .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--space-3); }

    /* Inputs */
    input[type="text"], select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-sage); border-radius: var(--radius-md); font-size: 1rem; background: white; color: var(--forest-shadow); }
    input[type="text"]:focus, select:focus { outline: 3px solid var(--focus-ring); outline-offset: 1px; }
    .inline-input { width: 160px; display: inline-block; margin: 0 6px; }

    /* Matching chips */
    .chip-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { border: 1px solid var(--border-sage); background: var(--warm-cream); border-radius: 14px; padding: 8px 12px; font-weight: 700; cursor: pointer; }
    .chip.selected { background: var(--secondary-sage); color: #fff; border-color: var(--secondary-sage); }

    /* Feedback */
    .feedback { font-weight: 800; margin-top: 10px; }
    .feedback.correct { color: #1b5e20; }
    .feedback.incorrect { color: #b71c1c; }
    .callout { padding: 12px; border-radius: var(--radius-md); background: var(--warm-cream); border: 1px solid var(--border-sage); }
    .score-box { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background: var(--warm-cream); border: 1px solid var(--border-sage); font-weight: 800; }

    /* Screen control */
    .screen { display: none; }
    .screen.active { display: block; }

    @media (max-width: 720px) {
      #app-wrapper { padding: var(--space-4); }
      .activity-container { padding: var(--space-8); }
    }
  </style>
</head>
<body>
  <div id="app-wrapper">
    <div class="activity-container">
      <header>
        <p class="pill"><i class="fa-solid fa-film"></i> B1 Pre-class Activity</p>
        <h1>Hebron–Paris Connection: Pre-class Prep</h1>
        <p class="muted">Independent, self-marking tasks to activate vocabulary and grammar before class.</p>
      </header>

      <div class="screen-nav" aria-label="Screen navigation">
        <button id="prev-btn" class="nav-btn" type="button" disabled><i class="fa-solid fa-arrow-left"></i> Back</button>
        <div class="progress">
          <div class="progress-track" aria-hidden="true"><div id="progress-fill" class="progress-fill"></div></div>
        </div>
        <button id="next-btn" class="nav-btn" type="button">Next <i class="fa-solid fa-arrow-right"></i></button>
      </div>

      <div id="screen-1" class="screen active" role="group" aria-labelledby="screen1-title">
        <div class="card">
          <p class="rubric">Screen 1 · Warm-up &amp; Instructions</p>
          <h2 id="screen1-title">Preview the collaboration</h2>
          <p>Read the context and follow the instructions before moving to the activities.</p>
          <div class="context">
            <p><strong>Context:</strong> Tariq in Hebron and Isabelle in Paris are preparing their co-produced film <em>"Jasmine in Paris"</em>. You will preview their updates, check key details, and practice the verb forms they use.</p>
            <ul class="instruction-list">
              <li>Each task marks itself. Use the <strong>Check</strong> buttons to get feedback and corrections.</li>
              <li>Spelling errors are auto-corrected where possible. You can retry as many times as you like.</li>
              <li>TensorFlow.js measures meaning similarity for short answers—paraphrases are accepted.</li>
              <li>Finish all screens to see your score summary.</li>
            </ul>
          </div>
        </div>
      </div>

      <div id="screen-2" class="screen" role="group" aria-labelledby="screen2-title">
        <div class="card">
          <p class="rubric">Screen 2 · Quick checks</p>
          <h2 id="screen2-title">Emails at a glance</h2>
          <p class="muted">Choose the option that fits the email extract from Tariq.</p>
          <div class="grid-two">
            <div>
              <p><strong>1.</strong> Tariq mentions the first draft...</p>
              <select data-answer="b">
                <option value="">Select</option>
                <option value="a">is being written now.</option>
                <option value="b">was finished last week.</option>
                <option value="c">will start next month.</option>
              </select>
            </div>
            <div>
              <p><strong>2.</strong> The call with Isabelle should happen...</p>
              <select data-answer="c">
                <option value="">Select</option>
                <option value="a">tonight without a time.</option>
                <option value="b">on any day this month.</option>
                <option value="c">next week on Tuesday or Wednesday.</option>
              </select>
            </div>
            <div>
              <p><strong>3.</strong> Casting decisions are...</p>
              <select data-answer="a">
                <option value="">Select</option>
                <option value="a">still open after talking to actors.</option>
                <option value="b">already fixed for the main roles.</option>
                <option value="c">waiting for the producer in Paris to approve.</option>
              </select>
            </div>
          </div>
          <button id="mc-check" class="nav-btn" type="button" style="margin-top: 14px;">Check answers</button>
          <div id="mc-feedback" class="feedback" aria-live="polite"></div>
        </div>
      </div>

      <div id="screen-3" class="screen" role="group" aria-labelledby="screen3-title">
        <div class="card">
          <p class="rubric">Screen 3 · Short answers</p>
          <h2 id="screen3-title">Semantic similarity checker</h2>
          <p class="muted">Answer with 1–5 words. Paraphrases are accepted using TensorFlow.js cosine similarity.</p>
          <div class="grid-two">
            <div>
              <p>1) Who finished the first draft?</p>
              <input type="text" data-answer="fatima" placeholder="Type a name" />
            </div>
            <div>
              <p>2) What was sent separately?</p>
              <input type="text" data-answer="script draft" placeholder="Type an item" />
            </div>
            <div>
              <p>3) When did they speak to actors?</p>
              <input type="text" data-answer="yesterday" placeholder="Type a time" />
            </div>
            <div>
              <p>4) Where are the actors?</p>
              <input type="text" data-answer="hebron" placeholder="Type a place" />
            </div>
          </div>
          <div class="callout" style="margin-top: 12px;">
            <p><strong>Tip:</strong> Minor spelling mistakes are corrected automatically. You will see suggestions in the feedback.</p>
          </div>
          <button id="sa-check" class="nav-btn" type="button" style="margin-top: 14px;">Check with AI</button>
          <div id="sa-feedback" class="feedback" aria-live="polite"></div>
        </div>
      </div>

      <div id="screen-4" class="screen" role="group" aria-labelledby="screen4-title">
        <div class="card">
          <p class="rubric">Screen 4 · Verb forms</p>
          <h2 id="screen4-title">Past Simple vs. Present Perfect</h2>
          <p class="muted">Tap each verb to label the tense. Past = <em>finished time</em>; Present Perfect = <em>past action with result now</em>.</p>
          <div class="chip-row" id="verb-row" aria-label="Verb chips">
            <span class="chip" data-tense="past">finished</span>
            <span class="chip" data-tense="present">have read</span>
            <span class="chip" data-tense="present">have sent</span>
            <span class="chip" data-tense="past">spoke</span>
            <span class="chip" data-tense="present">have started</span>
            <span class="chip" data-tense="present">have not decided</span>
          </div>
          <div class="callout" style="margin-top: 12px;">
            <p>First tap a tense button, then tap the verb chip. You can clear selections anytime.</p>
            <div class="chip-row">
              <button id="past-btn" class="nav-btn" type="button">Mark Past</button>
              <button id="present-btn" class="nav-btn" type="button">Mark Present Perfect</button>
              <button id="clear-btn" class="nav-btn" type="button">Clear</button>
            </div>
          </div>
          <div id="verb-feedback" class="feedback" aria-live="polite"></div>
        </div>

        <div class="card" style="margin-top: var(--space-4);">
          <p class="rubric">Score</p>
          <h2>Ready to submit?</h2>
          <p class="muted">When all activities are checked, view your score summary.</p>
          <div class="score-box" id="score-box" aria-live="polite">
            <i class="fa-solid fa-clipboard-check"></i>
            <span id="score-text">Score pending...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const screens = Array.from(document.querySelectorAll('.screen'));
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressFill = document.getElementById('progress-fill');
    let current = 0;
    let score = { mc: 0, sa: 0, verb: 0 };

    const updateScreen = () => {
      screens.forEach((s, i) => s.classList.toggle('active', i === current));
      prevBtn.disabled = current === 0;
      nextBtn.disabled = current === screens.length - 1;
      const ratio = ((current + 1) / screens.length) * 100;
      progressFill.style.width = `${ratio}%`;
    };

    prevBtn.addEventListener('click', () => { current = Math.max(0, current - 1); updateScreen(); });
    nextBtn.addEventListener('click', () => { current = Math.min(screens.length - 1, current + 1); updateScreen(); });

    // Multiple choice check
    document.getElementById('mc-check').addEventListener('click', () => {
      const selects = Array.from(document.querySelectorAll('#screen-2 select'));
      let correct = 0;
      selects.forEach(sel => {
        const expected = sel.dataset.answer;
        const chosen = sel.value;
        if (chosen === expected) {
          correct++;
          sel.style.borderColor = 'var(--correct-border)';
          sel.style.background = 'var(--correct-bg)';
        } else {
          sel.style.borderColor = 'var(--incorrect-border)';
          sel.style.background = 'var(--incorrect-bg)';
        }
      });
      score.mc = correct;
      const feedback = document.getElementById('mc-feedback');
      feedback.textContent = `${correct} / ${selects.length} correct. Adjust the red items.`;
      feedback.className = 'feedback ' + (correct === selects.length ? 'correct' : 'incorrect');
      updateTotal();
    });

    // TensorFlow similarity helpers
    const clean = (text) => text.toLowerCase().trim();
    const tokenize = (text) => clean(text).split(/[^a-z]+/).filter(Boolean);
    const vectorize = (tokens) => {
      const dict = {};
      tokens.forEach(tok => { dict[tok] = (dict[tok] || 0) + 1; });
      const keys = Object.keys(dict);
      return tf.tensor1d(keys.map(k => dict[k]));
    };
    const cosineSim = (aTokens, bTokens) => {
      const aVec = vectorize(aTokens);
      const bVec = vectorize(bTokens);
      const size = Math.max(aVec.size, bVec.size);
      const aPad = aVec.pad([[0, Math.max(0, size - aVec.size)]]);
      const bPad = bVec.pad([[0, Math.max(0, size - bVec.size)]]);
      const sim = tf.tidy(() => {
        const dot = tf.mul(aPad, bPad).sum();
        const denom = tf.sqrt(tf.mul(aPad, aPad).sum()).mul(tf.sqrt(tf.mul(bPad, bPad).sum()));
        return dot.div(denom.add(1e-6)).dataSync()[0];
      });
      aVec.dispose(); bVec.dispose(); aPad.dispose(); bPad.dispose();
      return sim;
    };

    // simple spelling suggestion using closest token by Levenshtein distance
    const distance = (a, b) => {
      const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return dp[a.length][b.length];
    };

    document.getElementById('sa-check').addEventListener('click', () => {
      const inputs = Array.from(document.querySelectorAll('#screen-3 input'));
      let correct = 0;
      const suggestions = [];
      inputs.forEach(inp => {
        const target = clean(inp.dataset.answer);
        const user = clean(inp.value);
        if (!user) return;
        const sim = cosineSim(tokenize(user), tokenize(target));
        const nearMiss = distance(user, target) === 1;
        if (sim >= 0.7 || nearMiss) {
          correct++;
          inp.style.borderColor = 'var(--correct-border)';
          inp.style.background = 'var(--correct-bg)';
        } else {
          inp.style.borderColor = 'var(--incorrect-border)';
          inp.style.background = 'var(--incorrect-bg)';
          suggestions.push(`Try: "${target}"`);
        }
      });
      score.sa = correct;
      const feedback = document.getElementById('sa-feedback');
      feedback.textContent = `${correct} / ${inputs.length} answers match. ${suggestions.join(' · ')}`;
      feedback.className = 'feedback ' + (correct === inputs.length ? 'correct' : 'incorrect');
      updateTotal();
    });

    // Verb chips
    let selectedTense = null;
    document.getElementById('past-btn').addEventListener('click', () => { selectedTense = 'past'; });
    document.getElementById('present-btn').addEventListener('click', () => { selectedTense = 'present'; });
    document.getElementById('clear-btn').addEventListener('click', () => {
      document.querySelectorAll('#verb-row .chip').forEach(ch => ch.classList.remove('selected', 'correct', 'incorrect'));
      document.getElementById('verb-feedback').textContent = '';
      score.verb = 0;
      updateTotal();
    });

    document.querySelectorAll('#verb-row .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        if (!selectedTense) {
          document.getElementById('verb-feedback').textContent = 'Choose a tense button first.';
          return;
        }
        chip.dataset.user = selectedTense;
        chip.classList.add('selected');
        evaluateVerbs();
      });
    });

    const evaluateVerbs = () => {
      const chips = Array.from(document.querySelectorAll('#verb-row .chip'));
      let correct = 0;
      chips.forEach(chip => {
        const expect = chip.dataset.tense;
        const user = chip.dataset.user;
        chip.classList.remove('correct', 'incorrect');
        if (!user) return;
        if (expect === user) {
          correct++;
          chip.classList.add('correct');
          chip.style.background = 'var(--correct-bg)';
          chip.style.borderColor = 'var(--correct-border)';
        } else {
          chip.classList.add('incorrect');
          chip.style.background = 'var(--incorrect-bg)';
          chip.style.borderColor = 'var(--incorrect-border)';
        }
      });
      score.verb = correct;
      const fb = document.getElementById('verb-feedback');
      fb.textContent = `${correct} / ${chips.length} verbs labelled correctly. Tap again to adjust.`;
      fb.className = 'feedback ' + (correct === chips.length ? 'correct' : 'incorrect');
      updateTotal();
    };

    const updateTotal = () => {
      const total = score.mc + score.sa + score.verb;
      const max = 3 + 4 + 6; // mc + short answers + verbs
      const percent = Math.round((total / max) * 100);
      const box = document.getElementById('score-box');
      const text = document.getElementById('score-text');
      text.textContent = `Live score: ${total} / ${max} (${percent}%)`;
      box.style.borderColor = percent === 100 ? 'var(--correct-border)' : 'var(--border-sage)';
    };

    updateScreen();
  </script>
</body>
</html>
