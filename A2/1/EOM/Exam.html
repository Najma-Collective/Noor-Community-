<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2 Final Assessment: Experiences & Storytelling</title>

    <!-- 1. Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Questrial&display=swap" rel="stylesheet">

    <!-- 2. Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- 3. Embedded CSS Theme -->
    <style>
        /* =====================================================================
           Noor Community Activities â€” Enhanced UI System
           ===================================================================== */
        :root {
          --primary-sage: #7a8471; --secondary-sage: #9caf88; --tertiary-sage: #b8c5a6; --warm-cream: #f8f6f0; --soft-white: #fefcf7; --forest-shadow: #5a6b52; --ink: #2f3a2b; --ink-muted: #5a6b52; --border-sage: rgba(122, 132, 113, 0.2); --hover-sage: rgba(156, 175, 136, 0.15); --deep-forest: #3e4a3a; --moss: #6e7a67; --amber: #c6aa77;
          --font-display: "Questrial", system-ui, sans-serif; --font-body: "Nunito", system-ui, sans-serif;
          --step--1: clamp(0.88rem, 0.82rem + 0.18vw, 0.95rem); --step-0: clamp(1.00rem, 0.94rem + 0.28vw, 1.10rem); --step-1: clamp(1.13rem, 1.04rem + 0.42vw, 1.32rem); --step-2: clamp(1.35rem, 1.18rem + 0.68vw, 1.65rem); --step-3: clamp(1.75rem, 1.42rem + 1.10vw, 2.10rem); --step-4: clamp(2.25rem, 1.80rem + 1.65vw, 2.75rem);
          --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-5: 1.25rem; --space-6: 1.5rem; --space-7: 2rem; --space-8: 2.5rem; --space-9: 3rem;
          --radius-sm: 10px; --radius: 16px; --radius-lg: 20px;
          --shadow-1: 0 1px 2px rgba(34, 41, 32, 0.05), 0 2px 8px rgba(34, 41, 32, 0.06); --shadow-2: 0 4px 18px rgba(34, 41, 32, 0.08), 0 12px 28px rgba(34, 41, 32, 0.06); --shadow-3: 0 10px 40px rgba(34, 41, 32, 0.1), 0 20px 60px rgba(34, 41, 32, 0.08);
          --ring: 0 0 0 3px color-mix(in oklab, var(--soft-white) 60%, transparent), 0 0 0 5px color-mix(in srgb, var(--secondary-sage) 85%, #2f3a2b 15%);
          --transition-std: 250ms cubic-bezier(.2,.8,.2,1);
          --container-max: clamp(320px, 92vw, 940px); --container-padding: clamp(1.25rem, 5vw, 2rem);
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { margin: 0; font-family: var(--font-body); font-size: var(--step-0); line-height: 1.6; color: var(--ink); background: var(--warm-cream); -webkit-font-smoothing: antialiased; }
        .container { width: 100%; max-width: var(--container-max); margin: 0 auto; padding: 0 var(--container-padding); }
        h1, h2, h3 { font-family: var(--font-display); color: var(--forest-shadow); text-wrap: balance; }
        h1 { font-size: var(--step-4); text-align: center; line-height: 1.1; margin: 0 0 var(--space-3); }
        h2 { font-size: var(--step-3); margin: var(--space-8) 0 var(--space-4); border-bottom: 2px solid var(--border-sage); padding-bottom: var(--space-2); }
        h3 { font-size: var(--step-2); margin: 0 0 var(--space-3); }
        .activity-btn { min-height: 44px; padding: 0.75rem clamp(1.2rem, 4vw, 1.75rem); border-radius: 999px; border: 1px solid color-mix(in srgb, var(--primary-sage) 65%, #fff 35%); background: linear-gradient(180deg, var(--primary-sage), var(--deep-forest)); color: #fff; font-weight: 700; font-size: var(--step-0); letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; transition: all var(--transition-std); box-shadow: var(--shadow-1); }
        .activity-btn:hover { transform: scale(1.02); box-shadow: var(--shadow-2); background: linear-gradient(180deg, var(--moss), var(--deep-forest)); }
        .activity-btn:disabled { background: var(--tertiary-sage); cursor: not-allowed; opacity: 0.85; transform: none; box-shadow: none; }
        .mc-question, .activity-card { padding: clamp(1.25rem, 4vw, 1.75rem); border-radius: var(--radius); border: 1px solid var(--border-sage); background: linear-gradient(180deg, #fff, color-mix(in srgb, #fff 90%, var(--warm-cream) 10%)); box-shadow: var(--shadow-1); margin-bottom: var(--space-6); }
        .mc-question-text, .activity-card h3 { font-weight: 700; font-size: var(--step-1); color: var(--forest-shadow); line-height: 1.45; margin: 0 0 var(--space-5); }
        .activity-card h3 { color: var(--primary-sage); margin-top: 0; padding-bottom: var(--space-2); font-size: var(--step-2); }
        .mc-options-container { display: flex; flex-direction: column; gap: var(--space-3); }
        .mc-option-item input { display: none; }
        .mc-option-label { display: flex; align-items: center; gap: var(--space-3); cursor: pointer; padding: 0.75rem 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border-sage); background: var(--soft-white); transition: all var(--transition-std); }
        .mc-option-label:hover { background: var(--hover-sage); }
        .mc-option-label .option-control { flex-shrink: 0; width: 24px; height: 24px; border: 2px solid var(--tertiary-sage); background-color: var(--soft-white); transition: all var(--transition-std); position: relative; border-radius: 50%; }
        .mc-option-item input:checked + .mc-option-label .option-control { border-color: var(--primary-sage); background-color: var(--primary-sage); }
        .mc-option-item input:checked + .mc-option-label .option-control::after { content: ''; position: absolute; inset: 4px; border-radius: 50%; background-color: #fff; }
        .assessment-container { display: none; }
        #student-id-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #student-id-box { background: var(--soft-white); padding: var(--space-8); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-3); width: 90%; max-width: 400px; }
        #student-id-box h2 { margin-top: 0; }
        #student-id-input { width: 100%; padding: var(--space-3); margin: var(--space-5) 0; border: 1px solid var(--border-sage); border-radius: var(--radius-sm); font-size: var(--step-0); }
        .timer-bar { position: sticky; top: 0; width: 100%; background-color: var(--deep-forest); color: var(--soft-white); padding: var(--space-3) var(--space-4); text-align: center; font-weight: 700; z-index: 999; box-shadow: var(--shadow-2); }
        #countdown-timer { background-color: var(--amber); color: var(--deep-forest); padding: var(--space-1) var(--space-2); border-radius: 6px; margin-left: var(--space-2); }
        .hero-section { position: relative; background-size: cover; background-position: center; padding: clamp(3rem, 10vw, 6rem) 1.5rem; text-align: center; color: white; border-radius: 0 0 var(--radius-lg) var(--radius-lg); overflow: hidden; }
        .hero-overlay { position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.5); }
        .hero-content { position: relative; z-index: 2; }
        .hero-section h1 { color: white; }
        .pills { display: flex; justify-content: center; gap: var(--space-3); margin-top: var(--space-4); flex-wrap: wrap; }
        .pill { display: inline-block; padding: var(--space-2) var(--space-4); border-radius: 999px; font-size: var(--step--1); font-weight: 600; background-color: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); }
        .instructions-box { background-color: var(--soft-white); border: 2px solid var(--secondary-sage); border-radius: var(--radius); padding: var(--space-6); margin: var(--space-7) 0; }
        .instructions-box h3 { color: var(--primary-sage); margin-top: 0; }
        .instructions-box ul { padding-left: var(--space-6); }
        .instructions-box li { margin-bottom: var(--space-2); }
        .dropdown-question, .grammar-task { margin-bottom: var(--space-4); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-sage); }
        .dropdown-question:last-child, .grammar-task:last-child { border-bottom: none; }
        select { padding: var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--tertiary-sage); background-color: var(--soft-white); cursor: pointer; }
        input[type="text"].grammar-input { padding: var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--tertiary-sage); width: 150px; }
        textarea { width: 100%; min-height: 150px; padding: var(--space-4); border: 1px solid var(--tertiary-sage); border-radius: var(--radius); font-family: var(--font-body); font-size: var(--step-0); }
        .rubric { font-size: var(--step--1); color: var(--ink-muted); background-color: var(--warm-cream); padding: var(--space-4); border-radius: var(--radius-sm); margin-top: var(--space-4); }
        .feedback-correct { background-color: #d4edda !important; border-color: #155724 !important; }
        .feedback-incorrect { background-color: #f8d7da !important; border-color: #721c24 !important; }
        .correct-answer-text { color: #155724; font-weight: bold; margin-left: var(--space-3); }
        #submission-area { text-align: center; margin-top: var(--space-7); }
        #submission-feedback { display: none; padding: var(--space-6); margin-top: var(--space-7); border-radius: var(--radius); text-align: center; }
        #submission-feedback.success { background-color: #d4edda; color: #155724; }
        #submission-feedback.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div id="student-id-modal">
        <div id="student-id-box">
            <h2>A2 Final Assessment</h2>
            <p>Please enter your numeric Student ID to begin.</p>
            <input type="text" id="student-id-input" placeholder="e.g., 202412345" inputmode="numeric" pattern="[0-9]*">
            <button id="start-assessment-btn" class="activity-btn" disabled>Start Assessment</button>
        </div>
    </div>

    <div class="assessment-container">
        <div class="timer-bar">
            Time Remaining: <span id="countdown-timer">60:00</span>
        </div>

        <header class="hero-section" style="background-image: url('https://images.pexels.com/photos/733856/pexels-photo-733856.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');">
            <div class="hero-overlay"></div>
            <div class="hero-content container">
                <h1>A2 Final Assessment</h1>
                <div class="pills">
                    <span class="pill"><i class="fa-solid fa-layer-group"></i> Level: A2</span>
                    <span class="pill"><i class="fa-solid fa-book-open"></i> Unit: Experiences & Storytelling</span>
                    <span class="pill"><i class="fa-solid fa-clock"></i> Duration: 60 Minutes</span>
                </div>
            </div>
        </header>

        <main class="container" style="padding-top: 2rem;">

            <div class="instructions-box">
                <h3>Welcome to Your Final Assessment!</h3>
                <p>This test will check your understanding of telling stories about past experiences. Please read the instructions for each section carefully.</p>
                <ul>
                    <li><b>Section A: Listening</b> (Suggested time: 10 minutes)</li>
                    <li><b>Section B: Reading</b> (Suggested time: 15 minutes)</li>
                    <li><b>Section C: Grammar & Vocabulary</b> (Suggested time: 15 minutes)</li>
                    <li><b>Section D: Writing</b> (Suggested time: 15 minutes)</li>
                </ul>
                <p>Good luck! You can do this!</p>
            </div>

            <!-- ======================= SECTION A: LISTENING ======================= -->
            <section class="assessment-section">
                <h2>Section A: Listening Comprehension</h2>
                <p style="text-align:center;">Listen to the conversation about a weekend trip. You can listen more than once.</p>
                
                <audio controls style="width: 100%; margin-bottom: 1.5rem;">
                    <source src="https://www.eslfast.com/robot/audio/06/0601.mp3" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>

                <div class="activity-card">
                    <h3>Activity 1: Main Ideas</h3>
                    <div class="mc-question" data-question-id="1.1" data-correct-answer="b">
                        <p class="mc-question-text">1. What is the conversation about?</p>
                        <div class="mc-options-container">
                            <div class="mc-option-item"><input type="radio" name="q1.1" value="a" id="q1.1a"><label for="q1.1a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) A work project</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q1.1" value="b" id="q1.1b"><label for="q1.1b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) A weekend trip</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q1.1" value="c" id="q1.1c"><label for="q1.1c" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">c) A movie they watched</span></label></div>
                        </div>
                    </div>
                    <div class="mc-question" data-question-id="1.2" data-correct-answer="c">
                        <p class="mc-question-text">2. Why didn't they go swimming?</p>
                        <div class="mc-options-container">
                            <div class="mc-option-item"><input type="radio" name="q1.2" value="a" id="q1.2a"><label for="q1.2a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) They did not have time.</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q1.2" value="b" id="q1.2b"><label for="q1.2b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) They forgot their swimsuits.</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q1.2" value="c" id="q1.2c"><label for="q1.2c" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">c) The water was too cold.</span></label></div>
                        </div>
                    </div>
                </div>
                <div class="activity-card">
                    <h3>Activity 2: True or False?</h3>
                    <p>Listen again and choose True or False for each sentence.</p>
                    <div class="mc-question" data-question-id="2.1" data-correct-answer="a">
                        <p class="mc-question-text">1. They went to the beach.</p>
                        <div class="mc-options-container">
                            <div class="mc-option-item"><input type="radio" name="q2.1" value="a" id="q2.1a"><label for="q2.1a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) True</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q2.1" value="b" id="q2.1b"><label for="q2.1b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) False</span></label></div>
                        </div>
                    </div>
                    <div class="mc-question" data-question-id="2.2" data-correct-answer="b">
                        <p class="mc-question-text">2. They played football.</p>
                        <div class="mc-options-container">
                            <div class="mc-option-item"><input type="radio" name="q2.2" value="a" id="q2.2a"><label for="q2.2a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) True</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q2.2" value="b" id="q2.2b"><label for="q2.2b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) False</span></label></div>
                        </div>
                    </div>
                     <div class="mc-question" data-question-id="2.3" data-correct-answer="a">
                        <p class="mc-question-text">3. They had a picnic for lunch.</p>
                        <div class="mc-options-container">
                            <div class="mc-option-item"><input type="radio" name="q2.3" value="a" id="q2.3a"><label for="q2.3a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) True</span></label></div>
                            <div class="mc-option-item"><input type="radio" name="q2.3" value="b" id="q2.3b"><label for="q2.3b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) False</span></label></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================= SECTION B: READING ======================= -->
            <section class="assessment-section">
                <h2>Section B: Reading Comprehension</h2>
                <div class="activity-card">
                    <h3>Activity 3: Read and Understand</h3>
                    <p>Read the email about a day trip and answer the questions below.</p>
                    <div style="background-color: var(--warm-cream); padding: var(--space-4); border-radius: var(--radius-sm); margin-bottom: var(--space-6);">
                        <p><strong>Subject: My Trip to the Old City</strong></p>
                        <p>Hi Samira,</p>
                        <p>I had a great day yesterday! I visited the Old City with my friend.</p>
                        <p>First, we walked through the old market. There were so many interesting shops. Then, we visited a famous historic building. I took a lot of photos. After that, we were hungry, so we ate lunch at a small restaurant. There was delicious local food. Finally, we bought some souvenirs before we went home.</p>
                        <p>It was a fun day.</p>
                        <p>See you soon,<br>Omar</p>
                    </div>

                    <div class="mc-question" data-question-id="3.1" data-correct-answer="b"><p class="mc-question-text">1. What is the main idea of the email?</p><div class="mc-options-container"><div class="mc-option-item"><input type="radio" name="q3.1" value="a" id="q3.1a"><label for="q3.1a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) A work meeting</span></label></div><div class="mc-option-item"><input type="radio" name="q3.1" value="b" id="q3.1b"><label for="q3.1b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) A trip Omar took</span></label></div><div class="mc-option-item"><input type="radio" name="q3.1" value="c" id="q3.1c"><label for="q3.1c" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">c) A new restaurant</span></label></div></div></div>
                    <div class="mc-question" data-question-id="3.2" data-correct-answer="c"><p class="mc-question-text">2. What did Omar do AFTER he visited the historic building?</p><div class="mc-options-container"><div class="mc-option-item"><input type="radio" name="q3.2" value="a" id="q3.2a"><label for="q3.2a" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">a) He went home.</span></label></div><div class="mc-option-item"><input type="radio" name="q3.2" value="b" id="q3.2b"><label for="q3.2b" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">b) He walked in the market.</span></label></div><div class="mc-option-item"><input type="radio" name="q3.2" value="c" id="q3.2c"><label for="q3.2c" class="mc-option-label"><span class="option-control"></span><span class="mc-option-text">c) He ate lunch.</span></label></div></div></div>
                </div>
                <div class="activity-card">
                    <h3>Activity 4: Sequence the Story</h3>
                    <p>Read the email again. Put the events from Omar's story in the correct order (1, 2, 3, 4).</p>
                    <div class="dropdown-question" data-correct-answer="3">He ate lunch at a restaurant. <select name="seq1"><option value="">-- Order --</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
                    <div class="dropdown-question" data-correct-answer="1">He walked through the old market. <select name="seq2"><option value="">-- Order --</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
                    <div class="dropdown-question" data-correct-answer="4">He bought souvenirs. <select name="seq3"><option value="">-- Order --</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
                    <div class="dropdown-question" data-correct-answer="2">He visited a historic building. <select name="seq4"><option value="">-- Order --</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
                </div>
            </section>
            
            <!-- ======================= SECTION C: GRAMMAR & VOCABULARY ======================= -->
            <section class="assessment-section">
                <h2>Section C: Grammar & Vocabulary</h2>
                <div class="activity-card">
                    <h3>Activity 5: Past Simple Verbs</h3>
                    <p>Choose the correct Past Simple form of the verb to complete each sentence.</p>
                    <div class="dropdown-question" data-correct-answer="watched">1. Yesterday, I <select name="g5.1"><option value="">--</option><option>watch</option><option>watched</option></select> a great film on TV. <span class="correct-answer-text"></span></div>
                    <div class="dropdown-question" data-correct-answer="went">2. We <select name="g5.2"><option value="">--</option><option>went</option><option>go</option></select> to a concert last Saturday. <span class="correct-answer-text"></span></div>
                    <div class="dropdown-question" data-correct-answer="visited">3. She <select name="g5.3"><option value="">--</option><option>visited</option><option>visit</option></select> her family last week. <span class="correct-answer-text"></span></div>
                    <div class="dropdown-question" data-correct-answer="go">4. He didn't <select name="g5.4"><option value="">--</option><option>go</option><option>went</option></select> to work yesterday. <span class="correct-answer-text"></span></div>
                </div>
                <div class="activity-card">
                    <h3>Activity 6: Describing Past Scenes</h3>
                     <p>Choose the correct word, 'was' or 'were', to complete each sentence.</p>
                    <div class="dropdown-question" data-correct-answer="were">1. At the festival, there <select name="g6.1"><option value="">--</option><option>was</option><option>were</option></select> a lot of people. <span class="correct-answer-text"></span></div>
                    <div class="dropdown-question" data-correct-answer="was">2. There <select name="g6.2"><option value="">--</option><option>was</option><option>were</option></select> live music on a stage. <span class="correct-answer-text"></span></div>
                </div>
                 <div class="activity-card">
                    <h3>Activity 7: Making Questions</h3>
                    <p>Complete the questions with the correct word.</p>
                    <div class="grammar-task" data-correct-answer="Did">1. <input type="text" class="grammar-input" name="g7.1"> you have a good weekend? <span class="correct-answer-text"></span></div>
                    <div class="grammar-task" data-correct-answer="What">2. <input type="text" class="grammar-input" name="g7.2"> did you do on Friday night? <span class="correct-answer-text"></span></div>
                </div>
            </section>

            <!-- ======================= SECTION D: WRITING ======================= -->
            <section class="assessment-section">
                <h2>Section D: Writing</h2>
                <div class="activity-card">
                    <h3>Activity 8: Tell Your Story</h3>
                    <p>Write about a trip you took. It can be a real trip or an imaginary one. Write 4-6 sentences (about 40-60 words).</p>
                    <p><strong>Use these questions to help you:</strong></p>
                    <ul>
                        <li>Where did you go? (e.g., I went to Jericho.)</li>
                        <li>Who did you go with? (e.g., I went with my family.)</li>
                        <li>What did you do? (Use sequencing words like First, Then, Finally...)</li>
                        <li>Did you like it? (e.g., It was a great day.)</li>
                    </ul>
                    <textarea id="writing-task" placeholder="Start writing here... For example: Last year, I went to..."></textarea>
                    <div class="rubric">
                        <b>Your teacher will check your writing for:</b>
                        <br>1. Correct use of Past Simple verbs (e.g., went, saw, visited).
                        <br>2. Use of sequencing words (First, Then, Finally).
                        <br>3. Good vocabulary for places and activities.
                    </div>
                </div>
            </section>

            <div id="submission-area">
                <p>You have finished the assessment. Please click the button below to submit.</p>
                <button id="submit-assessment-btn" class="activity-btn"><i class="fa-solid fa-paper-plane"></i> Submit Final Assessment</button>
            </div>
            <div id="submission-feedback"></div>
        </main>
    </div>

    <script>
    (function() {
        'use strict';
        const DURATION = 60 * 60; // 60 minutes
        let timeRemaining = DURATION;
        let timerInterval = null;
        let studentId = '';
        let assessmentSubmitted = false;
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwI1FuQM8gdwTSvU3FXVB7eX7EFoJCTWj0njCu2I6ibzCq2PtGQg_raW2gpocIVUuOviw/exec';

        const studentIdModal = document.getElementById('student-id-modal');
        const studentIdInput = document.getElementById('student-id-input');
        const startBtn = document.getElementById('start-assessment-btn');
        const assessmentContainer = document.querySelector('.assessment-container');
        const timerDisplay = document.getElementById('countdown-timer');
        const submitBtn = document.getElementById('submit-assessment-btn');

        studentIdInput.addEventListener('input', () => { startBtn.disabled = !/^\d{5,}$/.test(studentIdInput.value.trim()); });
        startBtn.addEventListener('click', () => {
            studentId = studentIdInput.value.trim();
            studentIdModal.style.display = 'none';
            assessmentContainer.style.display = 'block';
            startTimer();
        });

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = '00:00';
                    handleSubmission(true);
                }
            }, 1000);
        }

        submitBtn.addEventListener('click', () => handleSubmission(false));
        
        function handleSubmission(isAutoSubmit) {
            if (assessmentSubmitted) return;
            
            if (!isAutoSubmit && !confirm('Are you sure you want to submit your assessment?')) {
                return;
            }

            assessmentSubmitted = true;
            clearInterval(timerInterval);
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const { score, totalPoints } = calculateScore();
            
            showFeedback(score, totalPoints);
            submitToGoogleSheet(studentId, 'A2', `${score}/${totalPoints}`);
        }

        function calculateScore() {
            let score = 0;
            const questions = document.querySelectorAll('[data-correct-answer]');
            questions.forEach(q => {
                let userAnswer;
                if (q.classList.contains('mc-question')) {
                    userAnswer = q.querySelector('input:checked')?.value;
                } else if (q.classList.contains('dropdown-question')) {
                    userAnswer = q.querySelector('select').value;
                } else if (q.classList.contains('grammar-task')) {
                    const input = q.querySelector('input');
                    userAnswer = input.value.trim().charAt(0).toUpperCase() + input.value.trim().slice(1).toLowerCase();
                }

                if (userAnswer && userAnswer === q.dataset.correctAnswer) {
                    score++;
                }
            });
            return { score: score, totalPoints: questions.length };
        }

        function submitToGoogleSheet(id, level, finalScore) {
            const formData = new FormData();
            formData.append('Student ID', id);
            formData.append('Level', level);
            formData.append('Score', finalScore);
            // Optional: also submit the writing task
            formData.append('Writing Task', document.getElementById('writing-task').value);


            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                const feedbackEl = document.getElementById('submission-feedback');
                if (data.result === 'success') {
                    feedbackEl.innerHTML += `<p>Your results have been successfully recorded.</p>`;
                } else {
                    feedbackEl.classList.remove('success');
                    feedbackEl.classList.add('error');
                    feedbackEl.innerHTML += `<p>There was an error saving your results. Please contact your teacher.</p>`;
                }
            })
            .catch(error => {
                const feedbackEl = document.getElementById('submission-feedback');
                feedbackEl.classList.remove('success');
                feedbackEl.classList.add('error');
                feedbackEl.innerHTML += `<p>Could not connect to the server. Please check your internet connection and inform your teacher.</p>`;
            });
        }
        
        function showFeedback(score, totalPoints) {
            document.querySelectorAll('input, select, button, textarea').forEach(el => el.disabled = true);
            submitBtn.style.display = 'none';

            const feedbackEl = document.getElementById('submission-feedback');
            feedbackEl.style.display = 'block';
            feedbackEl.classList.add('success');
            feedbackEl.innerHTML = `<h2>Assessment Complete!</h2><p>Your auto-graded score is <strong>${score}/${totalPoints}</strong>.</p><p>Your teacher will review your writing section separately.</p>`;
            
            // Detailed feedback for each question
            document.querySelectorAll('[data-correct-answer]').forEach(q => {
                if (q.classList.contains('mc-question')) {
                    const correctAnswer = q.dataset.correctAnswer;
                    q.querySelectorAll('.mc-option-item').forEach(item => {
                        const radio = item.querySelector('input');
                        const label = item.querySelector('label');
                        if (radio.value === correctAnswer) {
                            label.classList.add('feedback-correct');
                        } else if (radio.checked) {
                            label.classList.add('feedback-incorrect');
                        }
                    });
                } else if (q.classList.contains('dropdown-question') || q.classList.contains('grammar-task')) {
                    const element = q.querySelector('select, input');
                    const userAnswer = element.value.trim();
                    const correctAnswer = q.dataset.correctAnswer;
                    
                    // Case-insensitive check for grammar input
                    const isCorrect = q.classList.contains('grammar-task') 
                        ? userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                        : userAnswer === correctAnswer;

                    if (userAnswer) {
                        element.classList.add(isCorrect ? 'feedback-correct' : 'feedback-incorrect');
                    }
                    if (!isCorrect) {
                        const feedbackSpan = q.querySelector('.correct-answer-text');
                        if(feedbackSpan) feedbackSpan.textContent = `Correct answer: ${correctAnswer}`;
                    }
                }
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    })();
    </script>
</body>
</html>
